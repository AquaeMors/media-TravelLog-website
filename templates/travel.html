{% extends "base.html" %}
{% block title %}T&R Travel Log{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<link href="{{ url_for('static', filename='css/travel.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card card-rounded shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="h4 mb-0">Map</h1>
      <div class="d-flex gap-2">
        <button id="fitPinsBtn" class="btn btn-outline-secondary btn-sm">Zoom to pins</button>
        {% if current_user and current_user.can_travel_edit %}
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newLocationModal">New Location</button>
        {% endif %}
      </div>
    </div>
    <div id="map" class="rounded"></div>
    <div class="text-muted small mt-2">Starts zoomed out; scroll to zoom. Click a pin’s title to open the trip.</div>
  </div>
</div>

<h2 class="h5 mb-3">T&R Travel Log</h2>

<div class="row g-3">
  {% for t in trips %}
    {% set cover = (t.photos[0].thumb_path if t.photos) %}
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card card-rounded shadow-sm h-100 trip-card" data-bs-toggle="modal" data-bs-target="#trip{{ t.id }}">
        {% if cover %}
          <img class="trip-cover" src="/u/{{ cover }}" alt="Cover for {{ t.title }}" loading="lazy">
        {% else %}
          <div class="trip-cover placeholder-cover">No Photo</div>
        {% endif %}
        <div class="trip-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="trip-title">{{ t.title }}</div>
            {% if t.photos %}<span class="trip-count">{{ t.photos|length }}</span>{% endif %}
          </div>
          <div class="trip-addr">{{ t.address }}</div>
          {% if current_user and current_user.can_travel_edit %}
            <button class="btn btn-sm btn-outline-secondary mt-2 trip-edit" data-bs-toggle="modal" data-bs-target="#editTrip{{ t.id }}">Edit</button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Trip Modal -->
    <div class="modal fade" id="trip{{ t.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ t.title }}</h5>
              <div class="text-muted small">{{ t.address }}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <!-- LEFT -->
              <div class="col-lg-7">
                <div class="card card-rounded h-100 d-flex flex-column overflow-hidden">
                  <div class="card-body flex-grow-1 overflow-auto">
                    <h6 class="text-muted">Details</h6>
                    <dl class="row mb-3">
                      <dt class="col-4">Added</dt><dd class="col-8">{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                      <dt class="col-4">Latitude</dt><dd class="col-8">{{ t.lat if t.lat is not none else '—' }}</dd>
                      <dt class="col-4">Longitude</dt><dd class="col-8">{{ t.lon if t.lon is not none else '—' }}</dd>
                    </dl>

                    {% if t.comments %}
                      <hr>
                      <div class="mb-3"><strong>Notes</strong><div class="mt-1">{{ t.comments }}</div></div>
                    {% endif %}

                    <h6 class="text-muted">Photos</h6>
                    <div class="gallery-wrapper collapsed" id="galleryWrap{{ t.id }}">
                      <div class="gallery">
                        {% for p in t.photos %}
                          <a href="/u/{{ p.stored_path }}" target="_blank" rel="noopener">
                            <img src="/u/{{ p.thumb_path or p.stored_path }}" alt="Photo" loading="lazy">
                          </a>
                        {% endfor %}
                      </div>
                      <div class="gallery-fade"></div>
                    </div>
                    {% if t.photos|length > 6 %}
                      <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary gallery-toggle"
                                data-target="#galleryWrap{{ t.id }}"
                                data-collapsed-text="Show all photos"
                                data-expanded-text="Show less"
                                aria-expanded="false">Show all photos</button>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- RIGHT: comments -->
              <div class="col-lg-5">
                <div class="card card-rounded h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Comments</span>
                    <span class="badge text-bg-secondary">{{ t.user_comments|length }}</span>
                  </div>

                  <div class="card-body comments-panel">
                    <div class="comments-ui">
                      <!-- Composer (flush to edges, fixed at top of panel) -->
                      <form class="comments-composer" method="post" action="/travel/{{ t.id }}/comment" data-keep-modal>
                        <label class="form-label mb-1">Add a comment as <strong>{{ current_user.username }}</strong></label>
                        <textarea class="form-control" name="body" rows="3" maxlength="2000" placeholder="Share a thought…" required></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                          <div class="comments-toolbar">
                            <button type="button" class="btn-tool" title="Bold" disabled><i class="bi bi-type-bold"></i></button>
                            <button type="button" class="btn-tool" title="Italic" disabled><i class="bi bi-type-italic"></i></button>
                            <button type="button" class="btn-tool" title="Link" disabled><i class="bi bi-link-45deg"></i></button>
                          </div>
                          <button class="btn btn-sm btn-primary">Comment</button>
                        </div>
                      </form>
                    </div>

                    <!-- Only this list scrolls -->
                    <div class="comments-scroll">
                      {% if t.user_comments %}
                        {% for c in t.user_comments|sort(attribute='created_at', reverse=True) %}
                          <article class="comment-card">
                            <div class="d-flex justify-content-between">
                              <div class="comment-meta"><span class="author">{{ c.author }}</span></div>
                              {% if current_user and (current_user.id == c.user_id or current_user.can_travel_edit) %}
                                <form method="post" action="/travel/comment/{{ c.id }}/delete" class="ms-2" data-keep-modal data-confirm="Delete this comment?">
                                  <button class="btn-delete" title="Delete"><i class="bi bi-x-lg"></i></button>
                                </form>
                              {% endif %}
                            </div>
                            <div class="mt-2">{{ c.body }}</div>
                            <div class="comment-footer">
                              <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-react {{ 'has-count' if c.likes>0 }}"
                                        data-react="like" data-kind="trip" data-comment-id="{{ c.id }}"
                                        aria-pressed="{{ 'true' if c.user_reaction=='like' else 'false' }}">
                                  <i class="bi bi-arrow-up"></i>
                                  <span class="count">{{ c.likes }}</span>
                                </button>
                                <button type="button"
                                        class="btn btn-react {{ 'has-count' if c.dislikes>0 }}"
                                        data-react="dislike" data-kind="trip" data-comment-id="{{ c.id }}"
                                        aria-pressed="{{ 'true' if c.user_reaction=='dislike' else 'false' }}">
                                  <i class="bi bi-arrow-down"></i>
                                  <span class="count">{{ c.dislikes }}</span>
                                </button>
                              </div>
                              <span class="text-muted small" data-timeago="{{ c.created_at.isoformat() }}">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                          </article>
                        {% endfor %}
                        <div class="mt-3"><button type="button" class="btn btn-load-more w-100" disabled>Load More</button></div>
                      {% else %}
                        <div class="text-muted">No comments yet.</div>
                      {% endif %}
                    </div><!-- /.comments-scroll -->
                  </div><!-- /.card-body -->
                </div>
              </div>
            </div><!-- /row -->
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    {% if current_user and current_user.can_travel_edit %}
    <!-- Edit Trip Modal -->
    <div class="modal fade" id="editTrip{{ t.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/travel/{{ t.id }}/update" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title">Edit: {{ t.title }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Title</label>
                  <input name="title" class="form-control" value="{{ t.title }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address</label>
                  <input name="address" class="form-control" value="{{ t.address }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Latitude (optional)</label>
                  <input id="lat-edit-{{ t.id }}" name="lat" class="form-control" value="{{ t.lat if t.lat is not none }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Longitude (optional)</label>
                  <input id="lon-edit-{{ t.id }}" name="lon" class="form-control" value="{{ t.lon if t.lon is not none }}">
                </div>
                <div class="col-12">
                  <label class="form-label">Notes (optional)</label>
                  <textarea name="comments" class="form-control" rows="2">{{ t.comments or '' }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Add photos</label>
                  <input type="file" name="photos" class="form-control" multiple accept="image/*">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>

{% if current_user and current_user.can_travel_edit %}
<!-- New Trip Modal -->
<div class="modal fade" id="newLocationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="/travel/new" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Add New Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Title/Name</label>
              <input name="title" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Address</label>
              <input id="addr-input" name="address" class="form-control" placeholder="Start typing address…" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Latitude (optional)</label>
              <input id="new-lat" name="lat" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Longitude (optional)</label>
              <input id="new-lon" name="lon" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Notes (optional)</label>
              <textarea name="comments" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Upload pictures</label>
              <input type="file" name="photos" class="form-control" multiple accept="image/*">
              <div class="form-text">Large batches are fine; we resize thumbnails automatically.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="{{ url_for('static', filename='js/travel.js') }}"></script>
{% endblock %}
