{% extends "base.html" %}
{% block title %}Media Tracker{% endblock %}
{% block head %}
<link href="{{ url_for('static', filename='css/tracker.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-4">

  {% if mode == 'menu' %}
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Pick a media type</h1>
    </div>

    {% set ICONS = {
      'book': 'book',
      'movie': 'film',
      'show': 'tv',
      'anime': 'collection-play',
      'manga': 'journals',
      'manhwa': 'journals',
      'game': 'controller',
      'other': 'list'
    } %}

    <div class="row g-3">
      {% for t in MEDIA_TYPES %}
        <div class="col-6 col-md-4 col-lg-3">
          <a class="text-decoration-none text-reset" href="/tracker?type={{ t }}">
            <div class="card card-rounded shadow-sm type-card transition">
              <div class="card-body d-flex align-items-center gap-3">
                <div class="type-icon">
                  <i class="bi bi-{{ ICONS.get(t, 'list') }}" aria-hidden="true"></i>
                </div>
                <div>
                  <div class="fw-semibold text-capitalize">{{ t }}</div>
                  <div class="text-muted small">{{ type_counts[t] }} item{{ '' if type_counts[t]==1 else 's' }}</div>
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>

  {% else %}
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h4 mb-0">Media Tracker — <span class="text-capitalize">{{ type_filter }}</span></h1>
        <a href="/tracker" class="small">Change type</a>
      </div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newItemModal">New Item</button>
    </div>

    <!-- Filters -->
    <form id="filterForm" class="row gy-2 gx-2 align-items-center mb-3" method="get">
      <input type="hidden" name="type" value="{{ type_filter }}">
      <div class="col-auto">
        <select id="filter-status" class="form-select form-select-sm" name="status">
          <option value="all" {% if status_filter=='all' %}selected{% endif %}>All statuses</option>
          {% for s in STATUS_OPTIONS %}
            <option value="{{s}}" {% if status_filter==s %}selected{% endif %}>{{ s.title() }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <input class="form-control form-control-sm w-18rem" type="search" name="q" value="{{ q }}" placeholder="Search title/tags/notes">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-primary btn-sm">Filter</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Score</th>
            <th>Chapters</th>
            <th>Tags</th>
            <th>Added</th>
            <th style="width:1%;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr>
                <td class="fw-semibold">
                  <a href="#" data-bs-toggle="modal" data-bs-target="#item{{ r.id }}">{{ r.title }}</a>
                </td>
                <td>{{ r.status.title() }}</td>
                <td>{{ r.score if r.score is not none else '—' }}</td>
                <td>
                  {% if r.chapter_current is not none or r.chapter_total is not none %}
                    {{ r.chapter_current if r.chapter_current is not none else '?' }}
                    {% if r.chapter_total is not none %}/{{ r.chapter_total }}{% endif %}
                  {% else %}—{% endif %}
                </td>
                <td class="text-muted">{{ r.tags or '' }}</td>
                <td class="text-muted">{{ r.added_at.strftime('%Y-%m-%d') }}</td>
                <td class="text-end text-nowrap">
                  <button class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal" data-bs-target="#itemEdit{{ r.id }}">Edit</button>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-muted">No {{ type_filter }} yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- New Item Modal -->
    <div class="modal fade" id="newItemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/tracker">
            <div class="modal-header">
              <h5 class="modal-title">Add New <span class="text-capitalize">{{ type_filter }}</span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Title</label>
                  <input name="title" class="form-control" required>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Type</label>
                  <select id="add-media-type" name="media_type" class="form-select">
                    {% for t in MEDIA_TYPES %}
                      <option value="{{t}}" {% if t==type_filter %}selected{% endif %}>{{ t.title() }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Status</label>
                  <!-- Pre-fill with server status list for current type -->
                  <select id="add-status" name="status" class="form-select">
                    {% for s in STATUS_OPTIONS %}
                      <option value="{{ s }}">{{ s.title() }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Score</label>
                  <select name="score" class="form-select">
                    <option value="">0-10</option>
                    {% for n in range(0,11) %}
                      <option value="{{n}}">{{n}}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-9">
                  <label class="form-label">Tags/Genres</label>
                  <input name="tags" class="form-control" placeholder="Comma-separated">
                </div>

                <!-- Chapters (conditional via JS) -->
                <div id="chapter-fields" class="row g-2 mt-1 d-none">
                  <div class="col-auto">
                    <label class="form-label">Chapter (current)</label>
                    <input type="number" min="0" name="chapter_current" class="form-control w-9rem" placeholder="#">
                  </div>
                  <div class="col-auto">
                    <label class="form-label">Total chapters (optional)</label>
                    <input type="number" min="0" name="chapter_total" class="form-control w-9rem" placeholder="Total">
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label">Notes (optional)</label>
                  <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button class="btn btn-primary">Add</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Item Detail + Edit Modals -->
    {% for r in rows %}
    <div class="modal fade" id="item{{ r.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ r.title }}</h5>
              <div class="text-muted small">
                {{ type_filter.title() }} • Status: {{ r.status.title() }}
                {% if r.score is not none %} • Score: {{ r.score }}{% endif %}
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card card-rounded h-100">
                  <div class="card-body">
                    <h6 class="text-muted">Details</h6>
                    <dl class="row mb-0">
                      <dt class="col-5">Status</dt><dd class="col-7">{{ r.status.title() }}</dd>
                      <dt class="col-5">Score</dt><dd class="col-7">{{ r.score if r.score is not none else '—' }}</dd>
                      <dt class="col-5">Chapters</dt>
                      <dd class="col-7">
                        {% if r.chapter_current is not none or r.chapter_total is not none %}
                          {{ r.chapter_current if r.chapter_current is not none else '?' }}{% if r.chapter_total is not none %}/{{ r.chapter_total }}{% endif %}
                        {% else %}—{% endif %}
                      </dd>
                      <dt class="col-5">Tags</dt><dd class="col-7">{{ r.tags or '—' }}</dd>
                      <dt class="col-5">Added</dt><dd class="col-7">{{ r.added_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    </dl>
                    {% if r.notes %}
                      <hr>
                      <div><strong>Notes</strong><div class="mt-1">{{ r.notes }}</div></div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card card-rounded h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Comments</span>
                    <span class="badge text-bg-secondary">{{ r.comments|length }}</span>
                  </div>
                  <div class="card-body">
                    <form class="mb-3" method="post" action="/tracker/{{ r.id }}/comment">
                      <label class="form-label">Add a comment as <strong>{{ current_user.username }}</strong></label>
                      <textarea class="form-control mb-2" name="body" rows="2" maxlength="2000" placeholder="Share a thought…" required></textarea>
                      <div class="text-end">
                        <button class="btn btn-sm btn-primary">Post</button>
                      </div>
                    </form>

                    {% if r.comments %}
                      <div class="comments-list">
                        {% for c in r.comments|sort(attribute='created_at', reverse=True) %}
                          <div class="comment-item">
                            <div class="d-flex justify-content-between">
                              <div class="comment-meta">
                                <strong>{{ c.author }}</strong>
                                <span class="text-muted small">• {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                              </div>
                              {% if current_user and (current_user.id == c.user_id or current_user.can_approve_users) %}
                                <form method="post" action="/tracker/comment/{{ c.id }}/delete" onsubmit="return confirm('Delete this comment?');">
                                  <button class="btn btn-link btn-sm text-danger p-0">Delete</button>
                                </form>
                              {% endif %}
                            </div>
                            <div class="mt-1">{{ c.body }}</div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="text-muted">No comments yet.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div><!-- /row -->
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal (with data- hooks for external JS) -->
    <div class="modal fade" id="itemEdit{{ r.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/tracker/{{ r.id }}/update">
            <div class="modal-header">
              <h5 class="modal-title">Edit: {{ r.title }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Title</label>
                  <input name="title" class="form-control" value="{{ r.title }}" required>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Type</label>
                  <select id="edit-media-type-{{ r.id }}"
                          name="media_type"
                          class="form-select js-edit-type"
                          data-status-target="edit-status-{{ r.id }}"
                          data-current-status="{{ r.status }}">
                    {% for t in MEDIA_TYPES %}
                      <option value="{{t}}" {% if t==type_filter %}selected{% endif %}>{{ t.title() }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Status</label>
                  <select id="edit-status-{{ r.id }}" name="status" class="form-select"></select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Score</label>
                  <select name="score" class="form-select">
                    <option value="">—</option>
                    {% for n in range(0,11) %}
                      <option value="{{n}}" {% if r.score is not none and r.score==n %}selected{% endif %}>{{n}}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-9">
                  <label class="form-label">Tags/Genres</label>
                  <input name="tags" class="form-control" placeholder="Comma-separated" value="{{ r.tags or '' }}">
                </div>

                <!-- Chapters (shown/hidden by JS if type supports it) -->
                <div id="edit-chapter-fields-{{ r.id }}" class="row g-2 mt-1 d-none">
                  <div class="col-auto">
                    <label class="form-label">Chapter (current)</label>
                    <input type="number" min="0" name="chapter_current" class="form-control w-9rem"
                           value="{{ r.chapter_current if r.chapter_current is not none }}">
                  </div>
                  <div class="col-auto">
                    <label class="form-label">Total chapters (optional)</label>
                    <input type="number" min="0" name="chapter_total" class="form-control w-9rem"
                           value="{{ r.chapter_total if r.chapter_total is not none }}">
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label">Notes (optional)</label>
                  <textarea name="notes" class="form-control" rows="3">{{ r.notes or '' }}</textarea>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tracker.js') }}"></script>
{% endblock %}
